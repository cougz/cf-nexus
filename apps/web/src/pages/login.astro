---
import Layout from '../layouts/Layout.astro'

const apiUrl = import.meta.env.PUBLIC_API_URL || 'https://nexus-api.tim-9c0.workers.dev'
---

<Layout title="Login">
  <div class="max-w-md mx-auto">
    <h1 class="text-3xl font-bold mb-6">Welcome to Nexus</h1>
    <p class="text-gray-400 mb-8">Sign in using WebAuthn (passkey)</p>

  <form id="loginForm" class="space-y-4" onsubmit="return false;">
      <div>
        <label for="username" class="block text-sm font-medium text-gray-300 mb-2">
          Username
        </label>
        <input
          type="text"
          id="username"
          name="username"
          required
          minlength="3"
          maxlength="50"
          class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-gray-500"
          placeholder="Enter your username"
        />
      </div>

      <button
        type="button"
        id="signinButton"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900"
      >
        Sign In with Passkey
      </button>
    </form>

  <div id="error" class="mt-4 p-4 bg-red-900/50 border border-red-700 rounded-lg text-red-300 hidden"></div>

    <div id="success" class="mt-4 p-4 bg-green-900/50 border border-green-700 rounded-lg text-green-300 hidden"></div>

    <div id="js-error" class="mt-4 p-4 bg-yellow-900/50 border border-yellow-700 rounded-lg text-yellow-300 hidden">
      JavaScript failed to load. Please check console for errors.
    </div>
  </div>

  <script define:vars={{ apiUrl }}>
    const API_URL = apiUrl

    window.addEventListener('DOMContentLoaded', () => {
      const jsErrorDiv = document.getElementById('js-error')
      if (jsErrorDiv) {
        jsErrorDiv.classList.add('hidden')
      }
    })

    const signinButton = document.getElementById('signinButton')!

    if (!signinButton) {
      console.error('signinButton not found')
      const jsErrorDiv = document.getElementById('js-error')
      if (jsErrorDiv) {
        jsErrorDiv.textContent = 'Error: signinButton element not found. Please refresh the page.'
        jsErrorDiv.classList.remove('hidden')
      }
    } else {
      signinButton?.addEventListener('click', async (e) => {
      e.preventDefault()
      e.stopPropagation()
      e.stopImmediatePropagation()

      const usernameInput = document.getElementById('username') as HTMLInputElement
      const username = usernameInput?.value?.trim()

      const errorDiv = document.getElementById('error')!
      const successDiv = document.getElementById('success')!

      errorDiv.classList.add('hidden')
      successDiv.classList.add('hidden')

      if (!username || username.length < 3 || username.length > 50) {
        errorDiv.textContent = 'Please enter a valid username (3-50 characters)'
        errorDiv.classList.remove('hidden')
        return
      }

      console.log('Starting login process for:', username)

      try {
        console.log('Step 1: Getting login options...')
        const optionsRes = await fetch(`${API_URL}/auth/login/options`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username }),
        })

        console.log('Response status:', optionsRes.status)

        if (!optionsRes.ok) {
          const error = await optionsRes.json()
          console.error('Options error:', error)
          throw new Error(error.error?.message || 'Failed to get login options')
        }

        const options = await optionsRes.json()
        console.log('Received options:', options.action)

        if (options.action === 'register') {
          console.log('Starting registration flow...')

          if (!navigator.credentials) {
            throw new Error('WebAuthn is not supported in this browser')
          }

          console.log('Calling navigator.credentials.create...')
          const credential = await navigator.credentials.create({
            publicKey: {
              rp: { id: options.rp.id, name: options.rp.name },
              user: {
                id: new TextEncoder().encode(options.user.id),
                name: options.user.name,
                displayName: options.user.displayName,
              },
              challenge: new TextEncoder().encode(options.challenge),
              pubKeyCredParams: options.pubKeyCredParams,
              timeout: options.timeout || 60000,
              attestation: options.attestation,
              authenticatorSelection: options.authenticatorSelection,
            },
          })

          if (!credential) {
            throw new Error('Registration cancelled')
          }

          console.log('Credential created, verifying...')

          const verifyRes = await fetch(`${API_URL}/auth/register/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              attestation: credential,
              challenge: options.challenge,
            }),
          })

          console.log('Verify response status:', verifyRes.status)

          if (!verifyRes.ok) {
            const error = await verifyRes.json()
            console.error('Verification error:', error)
            throw new Error(error.error?.message || 'Registration failed')
          }

          const result = await verifyRes.json()
          successDiv.textContent = `Account created for ${result.user.username}! Redirecting...`
          successDiv.classList.remove('hidden')

          setTimeout(() => {
            window.location.href = '/profile'
          }, 1500)
        } else if (options.action === 'authenticate') {
          console.log('Starting authentication flow...')

          if (!navigator.credentials) {
            throw new Error('WebAuthn is not supported in this browser')
          }

          console.log('Calling navigator.credentials.get...')

          const credential = await navigator.credentials.get({
            publicKey: {
              challenge: new TextEncoder().encode(options.challenge),
              rpId: options.rpId || window.location.hostname,
              allowCredentials: options.allowCredentials?.map((cred: any) => ({
                id: new Uint8Array(cred.id.split('').map(c => c.charCodeAt(0))),
                type: 'public-key',
                transports: cred.transports,
              })),
              userVerification: 'preferred',
              timeout: 60000,
            },
          })

          if (!credential) {
            throw new Error('Authentication cancelled')
          }

          console.log('Credential retrieved, verifying...')

          const verifyRes = await fetch(`${API_URL}/auth/login/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              assertion: credential,
              challenge: options.challenge,
            }),
          })

          console.log('Verify response status:', verifyRes.status)

          if (!verifyRes.ok) {
            const error = await verifyRes.json()
            console.error('Verification error:', error)
            throw new Error(error.error?.message || 'Authentication failed')
          }

          const result = await verifyRes.json()
          successDiv.textContent = `Welcome, ${result.user.username}! Redirecting...`
          successDiv.classList.remove('hidden')

          setTimeout(() => {
            window.location.href = '/profile'
          }, 1500)
        } else {
          throw new Error(`Unknown action: ${options.action}`)
        }
      } catch (err: any) {
        console.error('Error during authentication:', err)
        const errorDiv = document.getElementById('error')!
        errorDiv.textContent = err.message || 'Authentication failed'
        errorDiv.classList.remove('hidden')
      }

      return false
    })
  </script>
</Layout>
